```js const express = require("express"); const { Pool } = require("pg"); const app = express(); app.use(express.json()); const pool = new Pool({ connectionString: process.env.DATABASE_URL, ssl: process.env.DATABASE_URL?.includes("railway") ? { rejectUnauthorized: false } : undefined }); const PORT = process.env.PORT || 3000; // æµ‹è¯•æŽ¥å£ app.get("/", (req, res) => { res.send("VLTGO Support API is running ðŸš€"); }); // DB å¥åº·æ£€æŸ¥ app.get("/health", async (req, res) => { try { const r = await pool.query("SELECT NOW() as now"); res.json({ ok: true, db: true, now: r.rows[0].now }); } catch (err) { console.error("DB health check failed:", err); res .status(500) .json({ ok: false, db: false, error: String(err.message || err) }); } }); // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰ app.post("/admin/init-db", async (req, res) => { try { await pool.query(` CREATE TABLE IF NOT EXISTS contacts ( id SERIAL PRIMARY KEY, wa_id TEXT UNIQUE NOT NULL, display_name TEXT, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW() ); `); await pool.query(` CREATE TABLE IF NOT EXISTS conversations ( id SERIAL PRIMARY KEY, contact_id INTEGER NOT NULL REFERENCES contacts(id) ON DELETE CASCADE, status TEXT NOT NULL DEFAULT 'OPEN', last_message_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), unread_count INTEGER NOT NULL DEFAULT 0, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), UNIQUE(contact_id) ); `); await pool.query(` CREATE TABLE IF NOT EXISTS messages ( id SERIAL PRIMARY KEY, conversation_id INTEGER NOT NULL REFERENCES conversations(id) ON DELETE CASCADE, direction TEXT NOT NULL CHECK (direction IN ('inbound','outbound')), msg_type TEXT NOT NULL DEFAULT 'text', text TEXT, media_url TEXT, wa_message_id TEXT, created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), raw_payload JSONB ); `); await pool.query( `CREATE INDEX IF NOT EXISTS idx_messages_conversation_id ON messages(conversation_id);` ); await pool.query( `CREATE INDEX IF NOT EXISTS idx_messages_created_at ON messages(created_at);` ); await pool.query( `CREATE INDEX IF NOT EXISTS idx_conversations_last_message_at ON conversations(last_message_at);` ); res.json({ ok: true, message: "DB initialized" }); } catch (err) { console.error("init-db failed:", err); res.status(500).json({ ok: false, error: String(err.message || err) }); } }); // WhatsApp webhook éªŒè¯ app.get("/webhook", (req, res) => { const VERIFY_TOKEN = process.env.VERIFY_TOKEN || "test_token"; const mode = req.query["hub.mode"]; const token = req.query["hub.verify_token"]; const challenge = req.query["hub.challenge"]; if (mode === "subscribe" && token === VERIFY_TOKEN) { return res.status(200).send(challenge); } else { return res.sendStatus(403); } }); // æŽ¥æ”¶ webhookï¼ˆå†™å…¥æ•°æ®åº“ï¼‰ app.post("/webhook", async (req, res) => { try { const body = req.body; const entry = body?.entry?.[0]; const change = entry?.changes?.[0]; const value = change?.value; // ä¸æ˜¯ WhatsApp æ¶ˆæ¯äº‹ä»¶å°±ç›´æŽ¥ 200 if (!value || value.messaging_product !== "whatsapp") { return res.sendStatus(200); } const messages = value.messages; if (!messages || messages.length === 0) { return res.sendStatus(200); } // MVPï¼šåªå¤„ç†ç¬¬ä¸€æ¡ const msg = messages[0]; const wa_id = msg.from; // å®¢æˆ· WhatsApp IDï¼ˆé€šå¸¸æ˜¯æ‰‹æœºå·ï¼‰ const wa_message_id = msg.id; // WhatsApp message id const display_name = value?.contacts?.[0]?.profile?.name || null; let msg_type = msg.type || "text"; let text = null; if (msg_type === "text") { text = msg.text?.body || null; } else { // å…ˆä¸ä¸¢ï¼šåª’ä½“ç±»å…ˆç”¨å ä½æ–‡æœ¬è®°å½•ï¼Œä¸‹ä¸€æ­¥å†åšåª’ä½“ä¸‹è½½/è½¬å­˜ text = `[${msg_type} received - media handling pending]`; } // 1) upsert contact const contactResult = await pool.query( ` INSERT INTO contacts (wa_id, display_name) VALUES ($1, $2) ON CONFLICT (wa_id) DO UPDATE SET display_name = COALESCE(EXCLUDED.display_name, contacts.display_name) RETURNING id; `, [wa_id, display_name] ); const contact_id = contactResult.rows[0].id; // 2) upsert conversationï¼ˆä¸€å®¢ä¸€ä¼šè¯ï¼‰ const convResult = await pool.query( ` INSERT INTO conversations (contact_id, status, last_message_at, unread_count) VALUES ($1, 'OPEN', NOW(), 1) ON CONFLICT (contact_id) DO UPDATE SET last_message_at = NOW(), unread_count = conversations.unread_count + 1 RETURNING id; `, [contact_id] ); const conversation_id = convResult.rows[0].id; // 3) insert message await pool.query( ` INSERT INTO messages (conversation_id, direction, msg_type, text, wa_message_id, raw_payload) VALUES ($1, 'inbound', $2, $3, $4, $5); `, [conversation_id, msg_type, text, wa_message_id, body] ); console.log("Saved message:", { wa_id, conversation_id, msg_type }); return res.sendStatus(200); } catch (err) { console.error("Webhook handler error:", err); // MVP é˜¶æ®µè¿”å›ž 200ï¼Œé¿å… Meta é‡è¯•é£Žæš´ return res.sendStatus(200); } }); // æœ€åŽå†å¯åŠ¨æœåŠ¡å™¨ app.listen(PORT, () => { console.log(`Server running on port ${PORT}`); }); ``` ::contentReference[oaicite:0]{index=0}
